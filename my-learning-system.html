<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨ç‰ˆ</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI',Arial,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
.container { max-width:1200px; margin:0 auto; }
header { text-align:center; color:white; margin-bottom:30px; }
header h1 { font-size:2.5em; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
header p { font-size:1.2em; opacity:0.9; }
.main-grid { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:20px; }
.card { background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
.card h2 { color:#667eea; margin-bottom:20px; padding-bottom:10px; border-bottom:3px solid #667eea; }
.input-group { margin-bottom:15px; }
.input-group input { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:1em; transition:border-color 0.3s; }
.input-group input:focus { outline:none; border-color:#667eea; }
button { background:#667eea; color:white; border:none; padding:12px 24px; border-radius:8px; font-size:1em; cursor:pointer; transition:all 0.3s; }
button:hover { background:#5568d3; transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4); }
#response-area { margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px; min-height:100px; display:none; }
#response-area.show { display:block; animation:fadeIn 0.5s; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
.sidebar-section { margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:8px; }
.sidebar-section h3 { color:#667eea; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>ğŸ“ å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨ç‰ˆ</h1>
<p>LLM Ã— RAG Ã— ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼</p>
</header>

<div class="main-grid">
<div class="card">
<h2>ğŸ’¬ è³ªå•ãƒ»å­¦ç¿’ã‚¨ãƒªã‚¢</h2>
<div class="input-group">
<input type="text" id="question-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." onkeypress="if(event.key==='Enter') processQuestion()"/>
</div>
<button onclick="processQuestion()">è³ªå•ã™ã‚‹</button>
<button onclick="clearResponse()" style="background:#6c757d;">ã‚¯ãƒªã‚¢</button>
<div id="response-area"></div>
</div>

<div>
<div class="card">
<h2>ğŸ“Š æƒ…å ±ãƒ‘ãƒãƒ«</h2>
<div class="sidebar-section">
<h3>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
<div id="system-status"><p>åˆæœŸåŒ–ä¸­...</p></div>
</div>
<div class="sidebar-section">
<h3>çµ±è¨ˆæƒ…å ±</h3>
<div id="statistics">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
</div>
</div>
</div>
</div>
</div>

<script src="js/config.js"></script>
<script src="js/llm-client.js"></script>
<script src="js/vector-search.js"></script>
<script src="js/ontology.js"></script>
<script src="js/concept-extractor.js"></script>
<script src="js/semantic-rag.js"></script>

<script>
let semanticRAG;
let questionCount = 0;

// çŠ¶æ…‹æ›´æ–°
function updateStatus(msg){
    const el = document.getElementById('system-status');
    if(el) el.innerHTML = `<p style="padding:10px;background:white;border-radius:5px;">${msg}</p>`;
}

// çµ±è¨ˆæƒ…å ±æ›´æ–°
function updateStatistics(documentsData=null){
    const totalDocs = documentsData?.documents?.length || (semanticRAG?.documents?.length || 0);
    const statsElem = document.getElementById('statistics');
    if(statsElem){
        statsElem.innerHTML = `<p style="padding:10px;background:white;border-radius:5px;">
        è³ªå•æ•°: ${questionCount}å›<br>
        ç™»éŒ²æ–‡æ›¸: ${totalDocs}ä»¶<br>
        æ¦‚å¿µæ•°: ${semanticRAG?.ontology ? Object.keys(semanticRAG.ontology.concepts).length : 0}å€‹
        </p>`;
    }
}

// å›ç­”ã‚¯ãƒªã‚¢
function clearResponse(){
    const area=document.getElementById('response-area');
    if(area){ area.className=''; area.innerHTML=''; }
    document.getElementById('question-input').value='';
}

// è³ªå•å‡¦ç†
async function processQuestion(){
    const question=document.getElementById('question-input').value.trim();
    if(!question){ alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const responseArea=document.getElementById('response-area');
    responseArea.className='show';
    responseArea.innerHTML='<p>ğŸ¤” è€ƒãˆä¸­...</p>';
    try{
        const result = await semanticRAG.semanticQuery(question);
        responseArea.innerHTML = `<h3>ğŸ’¡ å›ç­”</h3>
            <p>${result.answer}</p>
            <h4>ğŸ”— é–¢é€£æ¦‚å¿µ</h4>
            <p>${(result.conceptsUsed||[]).join(', ')}</p>
            <h4>ğŸ“š å‚è€ƒæ–‡æ›¸</h4>
            <p>${(result.sources||[]).length}ä»¶ã®æ–‡æ›¸ã‚’å‚ç…§ã—ã¾ã—ãŸ</p>`;
        questionCount++;
        updateStatistics();
    }catch(err){
        responseArea.innerHTML = `<p style="color:red;">âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
    }
}

// åˆæœŸåŒ–
async function initialize(){
    updateStatus('åˆæœŸåŒ–ä¸­...');
    try{
        const ontologyData = await fetch('data/learning-ontology.json').then(r=>r.json());
        const documentsData = await fetch('data/sample-documents.json').then(r=>r.json());

        semanticRAG = new SemanticRAGSystem();
        await semanticRAG.initialize(documentsData.documents, ontologyData);

        // âœ… ä¿®æ­£ï¼šllmClient â†’ llm
        if(!semanticRAG.llm){
            console.error('LLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæœªæº–å‚™ã§ã™');
            updateStatus('âŒ LLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªæº–å‚™');
            return;
        }

        updateStatus('âœ… æº–å‚™å®Œäº†');
        updateStatistics(documentsData);

        // åˆæœŸåŒ–å¾Œã«4å›ç­”ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿé¨“ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¡¨ç¤ºï¼‰
        await experimentPrompts();
        await  experimentSearch();

    }catch(err){
        console.error('åˆæœŸåŒ–å¤±æ•—:', err);
        updateStatus('âŒ åˆæœŸåŒ–å¤±æ•—');
    }
}

// 4å›ç­”ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿé¨“ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¡¨ç¤ºï¼‰
async function experimentPrompts() {
    if (!semanticRAG?.llm) {
        console.warn('âš  LLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªæº–å‚™ã§ã™');
        return;
    }

    const question = "å¤‰æ•°ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ";
    const searchResult = await semanticRAG.semanticQuery(question);
    const sourcesText = (searchResult.sources || [])
        .map(s => s.document?.text || '')
        .join('\n\n') || 'å‚è€ƒæƒ…å ±ãªã—';

    const prompts = [
        { label: 'ãã®ã¾ã¾è³ªå•', text: question },
        { label: 'æ•™å¸«é¢¨èª¬æ˜', text:`ã‚ãªãŸã¯å„ªç§€ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¬›å¸«ã§ã™ã€‚è³ªå•: ${question}` },
        { label: '3ã‚¹ãƒ†ãƒƒãƒ—èª¬æ˜', text:`3ã‚¹ãƒ†ãƒƒãƒ—ã§èª¬æ˜ã—ã¦ãã ã•ã„:\n1. å®šç¾©\n2. ä¾‹\n3. é‡è¦æ€§\nè³ªå•: ${question}` },
        { label: 'RAGæ¤œç´¢çµæœå«ã‚€', text:`å‚è€ƒæƒ…å ±:\n${sourcesText}\nè³ªå•: ${question}` }
    ];

    console.log('================ 4å›ç­”ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿé¨“ é–‹å§‹ ================');

    for (let i = 0; i < prompts.length; i++) {
        try {
            const answer = await semanticRAG.llm.chat(prompts[i].text);
            console.log(`ğŸ“Œ å›ç­”${i+1} (${prompts[i].label}):\n${answer.response}\n`);
        } catch (err) {
            console.error(`âŒ å›ç­”${i+1}å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ (${prompts[i].label}):`, err);
        }
    }

    console.log('================ 4å›ç­”ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿé¨“ çµ‚äº† ================');
}
async function experimentSearch() {
    const query = "ãƒ«ãƒ¼ãƒ—ã®ä½¿ã„æ–¹";
    
    // æ–¹æ³•1: é€šå¸¸ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
    const vectorResults = await semanticRAG.searchEngine.search(query, 3);
    console.log('=== ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ ===');
    console.log(vectorResults);
    
    // æ–¹æ³•2: ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼å¼·åŒ–æ¤œç´¢
    const semanticResults = await semanticRAG.semanticQuery(query);
    console.log('=== ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼æ¤œç´¢ ===');
    console.log(semanticResults);
    
    // é•ã„ã‚’åˆ†æ
    console.log('=== æ¯”è¼ƒ ===');
    console.log('ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢:', vectorResults.length, 'ä»¶');
    console.log('ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼æ¤œç´¢:', semanticResults.sources.length, 'ä»¶');
    console.log('æŠ½å‡ºã•ã‚ŒãŸæ¦‚å¿µ:', semanticResults.conceptsUsed);
}

// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
window.onload = initialize;
</script>
</body>
</html>
